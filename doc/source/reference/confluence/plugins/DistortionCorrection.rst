Distortion Correction
-----------------------------

.. raw:: html

    <!DOCTYPE html>
    <html>
        <head>
            <title>Tomography Reconstruction : DistortionCorrection</title>
            <link rel="stylesheet" href="styles/site.css" type="text/css" />
            <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
        </head>

        <body class="theme-default aui-theme-default">
            <div id="page">
                <div id="main" class="aui-page-panel">


                    <div id="content" class="view">
                        <div class="page-metadata">







                Created by <span class='author'> Kaz Wanelik</span>, last modified on Oct 28, 2019
                            </div>
                        <div id="main-content" class="wiki-content group">
                        <p><br/></p><p><style type='text/css'>/*<![CDATA[*/
    div.rbtoc1592231715157 {padding: 0px;}
    div.rbtoc1592231715157 ul {list-style: disc;margin-left: 0px;}
    div.rbtoc1592231715157 li {margin-left: 0px;padding-left: 0px;}
    .syntaxhighlighter-pre {font-size: small;}
    table {font-size: small;}
    /*]]>*/</style><div class='toc-macro rbtoc1592231715157'>
    <ul class='toc-indentation'>
    <li><a href='#DistortionCorrection-Summary'>Summary</a></li>
    <li><a href='#DistortionCorrection-Parameters'>Parameters</a>
    <ul class='toc-indentation'>
    <li><a href='#DistortionCorrection-Briefdescription'>Brief description</a></li>
    <li><a href='#DistortionCorrection-Additionalnotes'>Additional notes</a></li>
    </ul>
    </li>
    <li><a href='#DistortionCorrection-Usage'>Usage</a></li>
    </ul>
    </div></p><h2 id="DistortionCorrection-Summary"><strong>Summary</strong></h2><p><strong><br/></strong></p><div class="table-wrap"><table class="wrapped relative-table confluenceTable" style="width: 99.9399%;"><colgroup><col style="width: 4.63576%;"/><col style="width: 16.478%;"/><col style="width: 7.00381%;"/><col style="width: 40.8238%;"/><col style="width: 22.7293%;"/><col style="width: 8.30423%;"/></colgroup><tbody><tr><td class="highlight-red confluenceTd" colspan="6" data-highlight-colour="red" style="text-align: center;"><strong>DistortionCorrection</strong></td></tr><tr><th class="highlight-yellow confluenceTh" data-highlight-colour="yellow" style="text-align: center;">Process category</th><th class="highlight-yellow confluenceTh" colspan="1" data-highlight-colour="yellow" style="text-align: center;">Brief description</th><th class="highlight-yellow confluenceTh" colspan="1" data-highlight-colour="yellow"><p style="text-align: center;">Computational demand</p><p style="text-align: center;">for typical tomography data</p><p style="text-align: center;">(low, medium, high)</p></th><th class="highlight-yellow confluenceTh" colspan="1" data-highlight-colour="yellow" style="text-align: center;">Comment(s)</th><th class="highlight-yellow confluenceTh" colspan="1" data-highlight-colour="yellow" style="text-align: center;">Reference(s)</th><th class="highlight-yellow confluenceTh" colspan="1" data-highlight-colour="yellow" style="text-align: center;">Common alternative process(es)</th></tr><tr><td class="confluenceTd">corrector</td><td colspan="1" class="confluenceTd">To correct raw data for lens distortion.</td><td colspan="1" class="confluenceTd">Medium</td><td colspan="1" class="confluenceTd"><ol><li>Requires the information about the centre and coefficients of distortion, which need to be measured beforehand.</li><li>Vacant pixels are filled in with interpolated intensities, which may result in some amount of localised blurring.</li><li>Expects input to contain floating-point image data.</li><li><p>If you have identified (by whatever means) an optimal value of <em>CoR</em> prior to correcting your data for lens distortion, then the pixel coordinate of this <em>CoR</em> should be similarly transformed (i.e. using the same distortion-correction parameters) before it can be used to reconstruct the corrected, distortion-free dataset<code>: </code></p><p><em>CoR_corrected</em> = <em>CoD_x</em><code> + dx*(</code><span style="color: rgb(0,0,0);"><em><code class="java plain"><span style="color: rgb(255,102,0);">k<sub>0</sub></span></code></em><code class="java plain"> + <em><span style="color: rgb(255,102,0);">k<sub>1</sub></span></em></code><code class="java plain"><em>*|dx| </em>+ <em><span style="color: rgb(255,102,0);">k<sub>2</sub></span></em></code><code class="java plain"><em>*<span style="color: rgb(0,0,0);"><code class="java plain">dx<sup>2</sup></code></span></em> + <em><span style="color: rgb(255,102,0);">k<sub>3</sub></span></em></code><code class="java plain"><em>*</em><span style="color: rgb(0,0,0);"><code class="java plain"><em>|dx|</em><sup><em>3</em> </sup></code></span>+ <em><span style="color: rgb(255,102,0);">k<sub>4</sub><span style="color: rgb(0,0,0);"><code class="java plain">*dx<sup>4</sup></code></span></span></em></code></span>)</p><p>where d<em>x</em> = <em>CoR</em> - <em>CoD_x</em> with <em>CoD_x </em>standing for the horizontal coordinate of the centre of distortion (<em>CoD).</em> This calculation assumes that both<em> CoR</em> and <em>CoD</em> were determined for images of the same width. Equivalently, one can compute <em>CoR_corrected</em> using the formula:</p><p><em>CoR_corrected</em> = <em>CoR + ΔCoR</em></p><p>where <em>ΔCoR</em> = <code>dx*(</code><span style="color: rgb(0,0,0);"><em><code class="java plain"><span style="color: rgb(255,102,0);">k<sub>0</sub></span></code></em><code class="java plain"> - 1 + <em><span style="color: rgb(255,102,0);">k<sub>1</sub></span></em></code><code class="java plain"><em>*|dx| </em>+ <em><span style="color: rgb(255,102,0);">k<sub>2</sub></span></em></code><code class="java plain"><em>*dx<sup>2</sup></em> + <em><span style="color: rgb(255,102,0);">k<sub>3</sub></span></em></code><code class="java plain"><em>*</em><em>|dx|</em><sup><em>3</em> </sup>+ <em><span style="color: rgb(255,102,0);">k<sub>4</sub><span style="color: rgb(0,0,0);">*dx<sup>4</sup></span></span></em></code></span>).</p>Alternatively, one can manually tweak that old value of <em>CoR</em> by trial and error. </li><li><span style="color: rgb(0,0,0);"><span style="color: rgb(255,102,0);"><span style="color: rgb(0,0,0);">As this correction involves some intensity interpolation, it can result in some smoothing effects which can improve many undesirable artefacts, including ring artefacts.</span><br/></span></span></li></ol></td><td colspan="1" class="confluenceTd"><a class="external-link" href="https://www.osapublishing.org/oe/abstract.cfm?uri=oe-23-25-32859" rel="nofollow">Radial lens distortion correction with sub-pixel accuracy for X-ray micro-tomography </a></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h2 id="DistortionCorrection-Parameters"><strong>Parameters</strong></h2><p><strong><br/></strong></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/></colgroup><tbody><tr><th class="highlight-red confluenceTh" data-highlight-colour="red"><h3 id="DistortionCorrection-Briefdescription">Brief description</h3></th></tr></tbody></table></div><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Savu Configurator command</b></div><div class="codeContent panelContent pdl">
    <pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">&gt;&gt;&gt; disp -avv

    -------------------------------------------------------------------------------------
     1) DistortionCorrection(savu.plugins.corrections.distortion_correction)
      A plugin to apply a distortion correction.
        1)             crop_edges : 0
        When applied to previewed/cropped data, the result may contain zeros around the
        edges, which can be removed by cropping the edges by a specified number of
        pixels.
        2)            in_datasets : []
        Create a list of the dataset(s) to process.
        3)        centre_from_top : 995.24
        The centre of distortion in pixels from the top of the image.
        4)           out_datasets : []
        Create a list of the dataset(s) to create.
        5)      polynomial_coeffs : (1.00015076, 1.9289e-06, -2.4325e-08, 1.00439e-11, -3.99352e-15)
        Parameters of the radial distortion function.
        6)       centre_from_left : 1283.25
        The centre of distortion in pixels from the left of the image.
    -------------------------------------------------------------------------------------

    &gt;&gt;&gt; </pre>
    </div></div><div class="table-wrap"><table class="wrapped confluenceTable"><tbody><tr><th class="highlight-red confluenceTh" data-highlight-colour="red"><h3 id="DistortionCorrection-Additionalnotes">Additional notes</h3></th></tr></tbody></table></div><p>For basic information on this process, please use the <em><strong>disp -av </strong></em>(or <em><strong>disp -avv </strong></em>or <em><strong>disp</strong></em><strong> </strong><strong>-v</strong>[<strong>v</strong>] <strong>&lt;</strong><em>process index</em><strong>&gt;</strong>) command in <strong>Savu Configurator </strong>(see above). The table below is intended to provide some additional notes on a number of selected topics:</p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 100.0%;"><colgroup><col style="width: 3.58123%;"/><col style="width: 9.70397%;"/><col style="width: 15.7112%;"/><col style="width: 16.0%;"/><col style="width: 18.5415%;"/><col style="width: 36.4477%;"/></colgroup><tbody><tr><th class="highlight-yellow confluenceTh" data-highlight-colour="yellow" rowspan="2" style="text-align: center;">Item</th><th class="highlight-yellow confluenceTh" data-highlight-colour="yellow" rowspan="2" style="text-align: center;">Parameter name</th><th class="highlight-yellow confluenceTh" data-highlight-colour="yellow" rowspan="2" style="text-align: center;">Parameter format</th><th class="highlight-yellow confluenceTh" colspan="2" data-highlight-colour="yellow" style="text-align: center;">Example(s)</th><th class="highlight-yellow confluenceTh" data-highlight-colour="yellow" rowspan="2" style="text-align: center;">Comment(s)</th></tr><tr><th class="highlight-yellow confluenceTh" data-highlight-colour="yellow" style="text-align: center;">Parameter value</th><th class="highlight-yellow confluenceTh" colspan="1" data-highlight-colour="yellow" style="text-align: center;">Effect</th></tr><tr><td class="confluenceTd">1</td><td class="confluenceTd"><p><em>crop_edges<br/></em></p></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><span style="color: rgb(128,0,0);">40</span></td><td colspan="1" class="confluenceTd"><span style="color: rgb(0,0,0);">T</span>o crop a given 3d dataset of shape (<span style="color: rgb(255,102,0);"><em>Z</em></span>, <span style="color: rgb(255,102,0);"><em>img_W</em></span>, <em><span style="color: rgb(255,102,0);">img_</span><span style="color: rgb(255,102,0);">L</span>)</em> to that of shape (<span style="color: rgb(255,102,0);"><em>Z</em></span>, <span style="color: rgb(255,102,0);"><em>img_W</em></span> - 2*<span style="color: rgb(128,0,0);">40</span>, <span style="color: rgb(255,102,0);"><em>img_</em></span><span style="color: rgb(255,102,0);"><em>L</em></span> - 2*<span style="color: rgb(128,0,0);">40</span>) in order to remove void pixels in the lens-distortion-corrected dataset, [0:<span style="color: rgb(255,102,0);"><em>Z</em></span>, <span><span><span style="color: rgb(128,0,0);">40</span>:-<span style="color: rgb(128,0,0);">40</span></span></span>, <span><span><span style="color: rgb(128,0,0);">40</span>:-<span style="color: rgb(128,0,0);">40</span></span></span>].  </td><td colspan="1" class="confluenceTd"><ol><li>Integer value in pixel units.</li><li>Images are first lens-distortion corrected, and then cropped by the <strong><em>crop_edges</em></strong> amount (note that the <strong><em>crop_edges</em></strong> amount should not be subtracted from the<strong><em> centre_from_left</em></strong> parameter as these two parameters are independent).</li><li>The amount to be used for setting the <strong><em>crop_edges</em></strong> parameter depends on the amount of lens distortion, but around <span style="color: rgb(128,0,0);">40</span> pixels is usually recommended as an initial value.  </li><li>Void pixels are an unwanted by-product of lens-distortion correction as they don't have any physically-meaningful (measured or calculated) intensity assigned to them, and thus have no informational content.</li><li>If you happen to have at your disposal an optimal value of <em>CoR</em> determined (by some means) for the dataset of the original shape, i. e. (<span style="color: rgb(255,102,0);"><em>Z</em></span>, <span style="color: rgb(255,102,0);"><em><span style="color: rgb(255,102,0);"><em>img_</em></span>W</em></span>, <span style="color: rgb(255,102,0);"><em>img_</em></span><span style="color: rgb(255,102,0);"><em>L</em></span>), and if you then wish to apply this <em>CoR</em> in a process list with the <strong><em>crop_edges</em></strong> parameter set to some non-zero value, then the pixel coordinate of your <em>CoR</em> (i. e. the value to be selected for setting the <strong><em>centre_of_rotation</em></strong> parameter of the reconstructor process in your process list) needs to be adjusted accordingly by manual intervention, here <em>CoR</em> - <span style="color: rgb(128,0,0);">40</span> (this value of <em>CoR</em> would should normally be lens-distortion-corrected beforehand). However, if your <strong>DistortionCorrection</strong> is followed by <strong><a href="VoCentering_76392254.html">VoCentering</a></strong>, which in turn is followed by a reconstructor, then this reconstructor's<em> <strong><em>centre_of_rotation</em></strong> </em>will automatically be set to the output value from the auto-centring process (and no further manual adjustment of this value on the account of the <strong><em>crop_edges</em></strong> parameter is needed in this case). </li><li>Note that, if the <strong><em>crop_edges</em></strong> parameter is non-zero, then the <span style="color: rgb(128,0,0);">n</span>-th slice in the dataset of the original shape, i. e. (<span style="color: rgb(255,102,0);"><em>Z</em></span>, <span style="color: rgb(255,102,0);"><em><span style="color: rgb(255,102,0);"><em>img_</em></span>W</em></span>,<span style="color: rgb(255,102,0);"><em> img_</em></span><span style="color: rgb(255,102,0);"><em>L</em></span>), will of course be different from the <span style="color: rgb(128,0,0);">n</span>-th slice in the cropped dataset; also, some of the original slices will obviously be no longer available in the cropped dataset, hence any subsequent processes in the process list will not be able to access them. </li><li>If the value of the <strong><em>crop_edges</em></strong> parameter of <strong>DistortionCorrection</strong> is non-zero, then the <strong><em>preview</em></strong><em> </em>parameter of any other process in the process list must be configured in a way that is compatible with the amount of cropping demanded by this particular value of <strong><em>crop_edges</em></strong><em> </em>(in other words, the dataset to crop from must be 'larger' than the amount of cropping requested in the relevant dimension). For example, to process a single slice numbered, say, <span style="color: rgb(153,51,0);">1500</span> using a process list with <strong><em>crop_edges</em></strong> set to <span style="color: rgb(153,51,0);">40</span>,  <strong> NxtomoLoader</strong>'s <em><strong>preview</strong></em> parameter needs to be set to <br/>[:,<span style="color: rgb(153,51,0);">1500</span>-<span style="color: rgb(153,51,0);">40</span>:<span style="color: rgb(153,51,0);">1500</span>+<span style="color: rgb(153,51,0);">40</span>+1,:] (rather than [:,<span style="color: rgb(153,51,0);">1500</span>:<span style="color: rgb(153,51,0);">1500</span>+1,:] or, equivalently, [:,<span style="color: rgb(153,51,0);">1500</span>,:]).</li><li>The cropping by the <strong><em>crop_edges</em></strong> amount is persistent, i.e. any process that follows <strong>DistortionCorrection</strong> can access nothing but the cropped-by-<strong><em>crop_edges</em></strong> dataset (or any of its subsets).</li></ol></td></tr><tr><td colspan="1" class="confluenceTd">2</td><td colspan="1" class="confluenceTd"><p><em><em>in_datasets</em><br/></em></p></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">3</td><td colspan="1" class="confluenceTd"><p><em>centre_from_top</em></p></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">Vertical pixel coordinate of the centre of distortion measured from the top edge of the (uncropped) image.</td></tr><tr><td colspan="1" class="confluenceTd">4</td><td colspan="1" class="confluenceTd"><p><em><em>out_datasets</em></em></p></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">5</td><td colspan="1" class="confluenceTd"><p><em>polynomial_coeffs</em></p></td><td colspan="1" class="confluenceTd"><span style="color: rgb(0,0,0);"><code class="java plain">[<span style="color: rgb(255,102,0);"><em>k<sub>0</sub></em></span></code><code class="java plain">, <span style="color: rgb(255,102,0);"><em>k<sub>1</sub></em></span></code><code class="java plain">, <span style="color: rgb(255,102,0);"><em>k<sub>2</sub></em></span></code><code class="java plain">, <span style="color: rgb(255,102,0);"><em>k<sub>3</sub></em></span></code><code class="java plain">, <span style="color: rgb(255,102,0);"><em>k<sub>4</sub></em></span></code><code class="java plain">]</code></span></td><td colspan="1" class="confluenceTd"><code class="java plain">[</code><span style="color: rgb(128,0,0);"><code class="java value">1.0</code></span><code class="java plain">, <span style="color: rgb(128,0,0);">0.0</span></code><code class="java plain">, <span style="color: rgb(128,0,0);">0.0</span></code><code class="java plain">, <span style="color: rgb(128,0,0);">0.0</span></code><code class="java plain">, <span style="color: rgb(128,0,0);">0.0</span></code><code class="java plain">]</code></td><td colspan="1" class="confluenceTd">To leave pixel intensities as they are (no correction for lens distortion).</td><td colspan="1" class="confluenceTd">Coefficients in a polynomial expansion describing the amount of lens distortion as a function of the distance from the centre of distortion. In the <em><strong>polynomial_coeffs</strong></em> list, the first coefficient<code> (</code>whose value is usually close to <span style="color: rgb(128,0,0);">1</span>) is the lowest order coefficient, describing the most dominant term in the expansion, <span style="color: rgb(0,0,0);"><code class="java plain"><span style="color: rgb(255,102,0);"><em>k<sub>0</sub></em></span></code></span>.</td></tr><tr><td colspan="1" class="confluenceTd">6</td><td colspan="1" class="confluenceTd"><p><em>centre_from_left</em></p></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd">Horizontal pixel coordinate of the centre of distortion measured from the left edge of the (uncropped) image (c.f. Comment 2 for the <em><strong>crop_edges</strong></em> parameter).</td></tr></tbody></table></div><p><br/></p><p><br/></p><h2 id="DistortionCorrection-Usage"><strong>Usage<br/></strong></h2><p>TBC.</p><p><br/></p><p><strong><br/></strong></p><p><strong><br/></strong></p>
                        </div>



                    </div>             </div>
                <div id="footer" role="contentinfo">
                    <section class="footer-body">
                        <p>Document generated by Confluence on Jun 15, 2020 15:35</p>
                        <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                    </section>
                </div>
            </div>     </body>
    </html>
